<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi H√†nh Gia Nh√≠ Kh√°m Ph√° V≈© Tr·ª•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: #0c0a1e;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%231a1a3d" fill-opacity="0.4"%3E%3Ccircle cx="50" cy="50" r="1"/%3E%3Ccircle cx="20" cy="20" r="1"/%3E%3Ccircle cx="80" cy="80" r="1"/%3E%3Ccircle cx="30" cy="70" r="1"/%3E%3Ccircle cx="70" cy="30" r="1"/%3E%3Ccircle cx="10" cy="50" r="1"/%3E%3Ccircle cx="90" cy="50" r="1"/%3E%3Ccircle cx="50" cy="10" r="1"/%3E%3Ccircle cx="50" cy="90" r="1"/%3E%3C/g%3E%3C/svg%3E');
        }
        .game-container {
            width: 100%;
            max-width: 1000px;
            height: 95vh;
            max-height: 700px;
            background: rgba(12, 10, 30, 0.8);
            border: 2px solid #4a4a8a;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(74, 74, 138, 0.5);
            overflow: hidden; /* Important for launch animation */
        }
        .start-screen h1 { text-shadow: 0 0 10px #ffc700, 0 0 20px #ffc700; }
        .btn-start {
            background: linear-gradient(45deg, #ff8c00, #ffc700);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.4);
            transition: all 0.3s ease;
        }
        .btn-start:hover { transform: translateY(-3px) scale(1.05); }
        
        .draggable { cursor: grab; transition: transform 0.2s ease-in-out, box-shadow 0.2s; }
        .draggable:hover { transform: scale(1.05); }
        .draggable:active { cursor: grabbing; transform: scale(1.15); }
        .dragging { opacity: 0.5; }
        
        .drop-zone { border: 2px dashed rgba(167, 139, 250, 0.5); transition: all 0.2s; }
        .drop-zone.drag-over { background: rgba(139, 92, 246, 0.3); border-color: #f59e0b; }
        .drop-zone.correct { border-color: transparent; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.5s ease-in-out; }

        @keyframes flame-flicker {
            0%, 100% { transform: scaleY(1) scaleX(1); opacity: 1; }
            50% { transform: scaleY(1.2) scaleX(0.9); opacity: 0.8; }
        }
        #launch-flames.active svg { animation: flame-flicker 0.2s infinite; }

        #progress-bar-container { background-color: rgba(0,0,0,0.3); }
        #progress-bar-fill { background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899); transition: width 0.5s ease-in-out; }
        #rocket-progress { transition: left 0.5s ease-in-out; }

        .quiz-item { border: 2px solid #4a4a8a; transition: all 0.2s ease; }
        .quiz-item.selected { border-color: #f59e0b; background-color: rgba(245, 158, 11, 0.2); transform: scale(1.05); }
        .quiz-item.matched { border-color: #4ade80; background-color: rgba(74, 222, 128, 0.2); opacity: 0.6; pointer-events: none; }

        .planet-glow-mercury { box-shadow: 0 0 15px 3px #a3a3a3; }
        .planet-glow-venus { box-shadow: 0 0 15px 3px #f59e0b; }
        .planet-glow-earth { box-shadow: 0 0 15px 3px #3b82f6; }
        .planet-glow-mars { box-shadow: 0 0 15px 3px #ef4444; }
        .planet-glow-jupiter { box-shadow: 0 0 15px 3px #d97706; }
        .planet-glow-saturn { box-shadow: 0 0 15px 3px #ca8a04; }
        .planet-glow-uranus { box-shadow: 0 0 15px 3px #67e8f9; }
        .planet-glow-neptune { box-shadow: 0 0 15px 3px #60a5fa; }
        
        /* Chat bubble styles */
        .chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1.25rem; }
        .chat-bubble-user { background-color: #3b82f6; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-model { background-color: #5b21b6; border-bottom-left-radius: 0.25rem; }
        
        /* Custom scrollbar for chat box */
        #gemini-response {
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }
        #gemini-response:hover {
            scrollbar-color: #4a4a8a transparent;
        }
        #gemini-response::-webkit-scrollbar {
            width: 8px;
        }
        #gemini-response::-webkit-scrollbar-track {
            background: transparent;
        }
        #gemini-response::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 4px;
        }
        #gemini-response:hover::-webkit-scrollbar-thumb {
            background-color: #4a4a8a;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen">

    <div id="game-container" class="game-container flex flex-col items-center justify-center p-4">

        <div id="start-screen" class="text-center">
            <h1 class="text-4xl md:text-6xl font-black text-yellow-300 mb-4">Phi H√†nh Gia Nh√≠ Kh√°m Ph√° V≈© Tr·ª•</h1>
            <h2 class="text-2xl md:text-3xl text-purple-300 mb-8">Little Astronaut: A Space Adventure</h2>
            <button id="start-button" class="btn-start text-gray-900 font-bold text-2xl px-12 py-4 rounded-full shadow-lg">
                B·∫ÆT ƒê·∫¶U
            </button>
        </div>

        <div id="game-screen" class="hidden w-full h-full flex-col">
            <div class="flex justify-between items-center p-2 border-b-2 border-purple-400/50">
                <h2 id="mission-title" class="text-xl md:text-2xl font-bold text-yellow-300">Nhi·ªám V·ª• 1: Trang B·ªã L√™n ƒê∆∞·ªùng (Gear Up!)</h2>
                <div class="flex items-center space-x-2 text-lg">
                    <span class="text-yellow-400">‚≠ê</span>
                    <span id="score" class="font-bold">0</span>
                </div>
            </div>

            <div class="w-full p-4">
                <div id="progress-bar-container" class="w-full h-4 rounded-full relative">
                    <div id="progress-bar-fill" class="h-full rounded-full" style="width: 0%;"></div>
                    <div id="rocket-progress" class="absolute top-1/2 -translate-y-1/2 text-2xl" style="left: 0%;">üöÄ</div>
                </div>
            </div>

            <div id="mission-content" class="flex-grow w-full relative">
                
                <button id="skip-button" class="hidden absolute top-2 right-4 bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-full z-20">B·ªè qua</button>
                
                <div id="mission-1-content" class="w-full h-full flex flex-col items-center justify-center p-4">
                    <h3 class="text-2xl font-bold text-center text-yellow-300 mb-1 z-10">Nhi·ªám V·ª• 1: L·∫Øp R√°p T√†u Con Thoi!</h3>
                    <p class="text-purple-200 mb-4">K√©o c√°c b·ªô ph·∫≠n v√†o ƒë√∫ng v·ªã tr√≠ ƒë·ªÉ ho√†n th√†nh con t√†u.</p>
                    <div class="w-full flex-grow flex items-center justify-around">
                        <div id="rocket-parts-bank" class="flex flex-col items-center space-y-4 p-4 bg-black/20 rounded-lg h-full justify-center">
                            <div id="cone-drag" data-item="cone" class="draggable" draggable="true"><svg class="w-20 h-20" viewBox="0 0 100 100"><path d="M50 0 L10 50 L90 50 Z" fill="#f87171"/><rect x="10" y="50" width="80" height="15" fill="#ef4444" rx="5"/></svg></div>
                            <div id="body-drag" data-item="body" class="draggable" draggable="true"><svg class="w-24 h-40" viewBox="0 0 100 150"><rect x="5" y="0" width="90" height="150" fill="#f3f4f6" rx="10"/><circle cx="50" cy="40" r="20" fill="#60a5fa" stroke="#3b82f6" stroke-width="4"/></svg></div>
                            <div id="fins-drag" data-item="fins" class="draggable" draggable="true"><svg class="w-32 h-24" viewBox="0 0 120 80"><path d="M0 80 L30 0 L50 80 Z" fill="#ef4444"/><rect x="40" y="0" width="40" height="80" fill="#9ca3af" rx="5"/><path d="M120 80 L90 0 L70 80 Z" fill="#ef4444"/></svg></div>
                        </div>
                        <div id="assembly-area" class="relative w-48 h-96">
                            <div id="cone-drop" data-item="cone" class="drop-zone absolute top-0 left-1/2 -translate-x-1/2 w-24 h-[100px]"></div>
                            <div id="body-drop" data-item="body" class="drop-zone absolute top-[80px] left-1/2 -translate-x-1/2 w-32 h-[160px]"></div>
                            <div id="fins-drop" data-item="fins" class="drop-zone absolute bottom-0 left-1/2 -translate-x-1/2 w-[140px] h-24"></div>
                            <div id="cone-assembled" class="absolute top-[10px] left-1/2 -translate-x-1/2 w-20 h-20 opacity-0 transition-opacity pointer-events-none"><svg class="w-full h-full" viewBox="0 0 100 100"><path d="M50 0 L10 50 L90 50 Z" fill="#f87171"/><rect x="10" y="50" width="80" height="15" fill="#ef4444" rx="5"/></svg></div>
                            <div id="body-assembled" class="absolute top-[80px] left-1/2 -translate-x-1/2 w-24 h-40 opacity-0 transition-opacity pointer-events-none"><svg class="w-full h-full" viewBox="0 0 100 150"><rect x="5" y="0" width="90" height="150" fill="#f3f4f6" rx="10"/><circle cx="50" cy="40" r="20" fill="#60a5fa" stroke="#3b82f6" stroke-width="4"/></svg></div>
                            <div id="fins-assembled" class="absolute bottom-0 left-1/2 -translate-x-1/2 w-32 h-24 opacity-0 transition-opacity pointer-events-none"><svg class="w-full h-full" viewBox="0 0 120 80"><path d="M0 80 L30 0 L50 80 Z" fill="#ef4444"/><rect x="40" y="0" width="40" height="80" fill="#9ca3af" rx="5"/><path d="M120 80 L90 0 L70 80 Z" fill="#ef4444"/></svg></div>
                            <div id="launch-flames" class="absolute bottom-[-50px] left-1/2 -translate-x-1/2 w-24 h-24 opacity-0 pointer-events-none"><svg viewBox="0 0 100 100"><path d="M20 100 L 50 20 L 80 100 L 65 80 L 50 100 L 35 80 Z" fill="#f59e0b"/><path d="M35 100 L 50 50 L 65 100 L 58 90 L 50 100 L 42 90 Z" fill="#fef08a"/></svg></div>
                        </div>
                    </div>
                </div>

                <div id="mission-2-content" class="hidden w-full h-full flex flex-col items-center justify-center">
                    <h3 id="mission-2-subtitle" class="text-xl text-center mb-2">V√≤ng 1: H√£y s·∫Øp x·∫øp c√°c h√†nh tinh theo ƒë√∫ng th·ª© t·ª±.</h3>
                    <div id="solar-system" class="w-full flex-grow flex items-center justify-center space-x-1 md:space-x-2 p-2 overflow-x-auto">
                         <div class="flex-shrink-0 flex flex-col items-center text-center"><div class="w-16 h-16 md:w-24 md:h-24 bg-yellow-400 rounded-full flex items-center justify-center animate-pulse shadow-[0_0_30px_#facc15]"></div><p class="font-bold mt-1">M·∫∑t Tr·ªùi</p></div>
                        <div id="planet-slots" class="flex items-center space-x-1 md:space-x-2"></div>
                    </div>
                    <div id="planet-bank" class="w-full bg-black/30 p-2 rounded-lg flex justify-center items-center flex-wrap gap-2"></div>
                </div>
                
                <div id="mission-3-content" class="hidden absolute inset-0 bg-black/70 z-10 flex items-center justify-center">
                     <div id="fun-fact-card" class="bg-indigo-900 border-2 border-purple-400 rounded-2xl p-6 text-center w-11/12 max-w-lg transform transition-all duration-500 scale-0 opacity-0">
                        <h3 id="fun-fact-title" class="text-3xl font-bold text-yellow-300 mb-4"></h3>
                        <div id="fun-fact-image" class="w-32 h-32 mx-auto mb-4"></div>
                        <p id="fun-fact-text" class="text-xl"></p>
                    </div>
                </div>

                <div id="mission-4-content" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
                     <h3 class="text-xl text-center mb-4">N·ªëi h√¨nh ·∫£nh v·ªõi t·ª´ ti·∫øng Anh ƒë√∫ng nh√©!</h3>
                     <div class="flex-grow w-full flex justify-around items-center">
                        <div id="quiz-images" class="flex flex-col space-y-4"></div>
                        <div id="quiz-words" class="flex flex-col space-y-4"></div>
                     </div>
                </div>
                
                <div id="mission-5-content" class="hidden w-full h-full flex flex-col p-4">
                    <div class="flex-shrink-0">
                        <h3 class="text-2xl font-bold text-center text-cyan-300 mb-2">‚ú® Tr√≤ Chuy·ªán C√πng V≈© Tr·ª• ‚ú®</h3>
                        <p class="text-center text-purple-200 mb-4">H·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ con th·∫Øc m·∫Øc v·ªÅ kh√¥ng gian nh√©! (Ch·ªâ 1 c√¢u h·ªèi th√¥i nha)</p>
                    </div>
                    <div id="gemini-response" class="flex-grow p-3 w-full bg-black/30 rounded-lg flex flex-col space-y-4 min-h-0 my-2"></div>
                    <div class="flex-shrink-0">
                        <div id="mic-status" class="text-center text-yellow-300 h-6"></div>
                        <div id="gemini-loader" class="hidden self-center my-2 flex items-center space-x-2"><div class="w-6 h-6 border-2 border-dashed rounded-full animate-spin border-yellow-400"></div><p class="text-purple-200">Tinh T√∫ ƒëang l·∫Øng nghe...</p></div>
                        <div class="mt-2 flex items-center space-x-2">
                            <input id="gemini-prompt" class="flex-grow bg-indigo-900/50 border-2 border-purple-400 rounded-full py-2 px-4 text-white text-lg focus:outline-none focus:border-yellow-400" placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c d√πng micro..."/>
                            <button id="mic-button" class="p-3 bg-purple-600 hover:bg-purple-700 rounded-full transition-colors"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button>
                            <button id="ask-gemini-button" class="p-3 bg-cyan-500 hover:bg-cyan-600 rounded-full transition-colors"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="mission-feedback" class="text-center h-10 mt-2">
                 <button id="next-button" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transition-transform hover:scale-105">Ti·∫øp theo</button>
            </div>
        </div>
        
        <div id="end-screen" class="hidden text-center">
            <h1 class="text-4xl md:text-5xl font-black text-green-400 mb-4">Ch√∫c m·ª´ng Phi H√†nh Gia Nh√≠!</h1>
            <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc nhi·ªám v·ª•!</h2>
             <div class="bg-indigo-800 border-2 border-yellow-400 rounded-full w-48 h-48 flex flex-col items-center justify-center mx-auto mb-6 shadow-lg">
                <div class="text-2xl">üèÜ</div>
                <div class="font-bold text-yellow-300">Huy hi·ªáu</div>
                <div class="font-bold text-lg text-white">Nh√† Kh√°m Ph√° Thi√™n H√†</div>
            </div>
            <p class="text-xl">T·ªïng s·ªë sao con ƒë·∫°t ƒë∆∞·ª£c: <span id="final-score" class="font-bold text-2xl text-yellow-400">0</span> ‚≠ê</p>
             <button id="restart-button" class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-transform hover:scale-105">Ch∆°i L·∫°i</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Game state
    let currentMission = 0;
    let score = 0;
    let mission2Round = 1;
    let mission4MatchedPairs = 0;
    let geminiChatHistory = [];
    let isSkippingMission3 = false; // ADDED
    
    // Elements
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const endScreen = document.getElementById('end-screen');
    const startButton = document.getElementById('start-button');
    const nextButton = document.getElementById('next-button');
    const restartButton = document.getElementById('restart-button');
    const skipButton = document.getElementById('skip-button'); // ADDED
    const scoreDisplay = document.getElementById('score');
    const finalScoreDisplay = document.getElementById('final-score');
    const missionTitle = document.getElementById('mission-title');
    const progressBarFill = document.getElementById('progress-bar-fill');
    const rocketProgress = document.getElementById('rocket-progress');

    const missionContents = { 1: document.getElementById('mission-1-content'), 2: document.getElementById('mission-2-content'), 3: document.getElementById('mission-3-content'), 4: document.getElementById('mission-4-content'), 5: document.getElementById('mission-5-content') };

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const synth = window.speechSynthesis;
    
    function playSound(type) { /* ... unchanged ... */ }
    
    // --- MODIFIED speak function ---
    speak = (text, options = {}) => {
        const { lang = 'vi-VN', rate = 0.75, pitch = 1.1 } = options;
        if (!synth) return;
        const u = new SpeechSynthesisUtterance(text);
        const v = synth.getVoices().find(v => v.lang === lang) || synth.getVoices().find(v => v.lang.startsWith(lang.substring(0,2))) || synth.getVoices().find(v => v.lang.startsWith('en')) || synth.getVoices()[0];
        if (v) {
            u.voice = v;
            u.lang = v.lang;
        } else {
            u.lang = lang;
        }
        u.rate = rate; // Use rate from options
        u.pitch = pitch; // Use pitch from options
        synth.cancel();
        synth.speak(u);
    };

    const planets = [ /* ... unchanged ... */ ];
    const funFacts = [ /* ... unchanged ... */ ];
    const quizItems = [ /* ... unchanged ... */ ];

    function updateScore(points) { score += points; scoreDisplay.textContent = score; }
    function updateProgressBar() { const progress = Math.min(100, (currentMission - 1) / 5 * 100); progressBarFill.style.width = `${progress}%`; rocketProgress.style.left = `calc(${progress}% - 12px)`; }
    
    // --- MODIFIED showMission function ---
    function showMission(missionNumber) {
        Object.values(missionContents).forEach(content => content.classList.add('hidden'));
        if (missionContents[missionNumber]) {
            missionContents[missionNumber].classList.remove('hidden');
        }
        nextButton.classList.add('hidden');
        skipButton.classList.add('hidden'); // ADDED
    }
    
    function playLaunchAnimation() { /* ... unchanged ... */ }
    function setupMission1() { /* ... unchanged ... */ }
    function setupMission2() { /* ... unchanged ... */ }
    // --- setupMission3 is MODIFIED below ---
    // --- setupMission4 is MODIFIED below ---

    // --- Start of Updated Mission 5 ---
    function renderChat() {
        const chatContainer = document.getElementById('gemini-response');
        chatContainer.innerHTML = '';
        geminiChatHistory.forEach(message => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${message.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`;
            bubble.textContent = message.parts[0].text;
            
            messageWrapper.appendChild(bubble);
            chatContainer.appendChild(messageWrapper);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    let questionAsked = false; // Flag for Mission 5

    async function askGemini() {
        if (questionAsked) return; // Only allow one question

        const promptInput = document.getElementById('gemini-prompt');
        const userQuery = promptInput.value.trim();
        if (!userQuery) return;

        promptInput.value = '';

        geminiChatHistory.push({ role: 'user', parts: [{ text: userQuery }] });
        renderChat();

        const geminiLoader = document.getElementById('gemini-loader');
        const askButton = document.getElementById('ask-gemini-button');
        const micButton = document.getElementById('mic-button');
        const micStatus = document.getElementById('mic-status');

        geminiLoader.classList.remove('hidden');
        askButton.disabled = true;
        micButton.disabled = true;

        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const systemPrompt = "B·∫°n l√† m·ªôt nh√† thi√™n vƒÉn h·ªçc th√¢n thi·ªán, t√™n l√† 'Tinh T√∫', ƒëang n√≥i chuy·ªán v·ªõi m·ªôt ƒë·ª©a tr·∫ª t·ª´ 6 ƒë·∫øn 10 tu·ªïi. H√£y tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ kh√¥ng gian m·ªôt c√°ch ƒë∆°n gi·∫£n, ng·∫Øn g·ªçn (t·ªëi ƒëa 3-4 c√¢u), v√† ƒë·∫ßy h·ª©ng kh·ªüi. S·ª≠ d·ª•ng nh·ªØng t·ª´ ng·ªØ d·ªÖ hi·ªÉu, v√≠ von ng·ªô nghƒ©nh. Lu√¥n gi·ªØ gi·ªçng ƒëi·ªáu vui v·∫ª, khuy·∫øn kh√≠ch v√† k·∫øt th√∫c b·∫±ng m·ªôt c√¢u h·ªèi nh·ªè ƒë·ªÉ g·ª£i m·ªü tr√≠ t√≤ m√≤. V√≠ d·ª•: '...Con c√≥ th·∫•y ƒëi·ªÅu ƒë√≥ k·ª≥ di·ªáu kh√¥ng?'";
        const payload = { contents: geminiChatHistory, systemInstruction: { parts: [{ text: systemPrompt }] } };

        try {
            let response;
            for (let i = 0; i < 3; i++) {
                response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) break;
                await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i)));
            }

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                geminiChatHistory.push(candidate.content);
                renderChat();
                speak(candidate.content.parts[0].text, { lang: 'vi-VN' }); // Uses default rate 0.9
                updateScore(20);

                // --- NEW LOGIC: End game after 1 question ---
                questionAsked = true; // Set flag
                document.getElementById('gemini-prompt').disabled = true;
                micStatus.textContent = "C·∫£m ∆°n con! Tinh T√∫ s·∫Øp ƒë∆∞a con v·ªÅ Tr√°i ƒê·∫•t r·ªìi.";
                
                // Automatically move to end screen after a delay
                setTimeout(showEndScreen, 4000); // Wait 4s
                // --- END NEW LOGIC ---

            } else { throw new Error("Invalid response structure from API"); }

        } catch (error) {
            console.error("Error calling Gemini API:", error);
            const errorMessage = { role: 'model', parts: [{ text: "√îi, c√≥ v·∫ª nh∆∞ c√°c v√¨ sao h√¥m nay h∆°i nhi·ªÖu s√≥ng. Con h√£y th·ª≠ l·∫°i sau nh√©!" }] };
            geminiChatHistory.push(errorMessage);
            renderChat();
            speak(errorMessage.parts[0].text, {lang: 'vi-VN'});
        } finally {
            geminiLoader.classList.add('hidden');
            // Only re-enable if the question *wasn't* successfully asked
            if (!questionAsked) {
                askButton.disabled = false;
                micButton.disabled = false;
            }
        }
    }

    function setupMission5() {
        currentMission = 5;
        missionTitle.innerHTML = 'Nhi·ªám V·ª• 5: ‚ú® Tr√≤ Chuy·ªán C√πng V≈© Tr·ª• ‚ú®';
        updateProgressBar();
        showMission(5); // This correctly hides skipButton
        speak('Nhi·ªám V·ª• 5: Tr√≤ Chuy·ªán C√πng V≈© Tr·ª•. H·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ con th·∫Øc m·∫Øc v·ªÅ kh√¥ng gian nh√©!', {lang: 'vi-VN'}); // Default rate 0.9

        questionAsked = false; // Reset flag for this mission
        geminiChatHistory = []; // Reset history
        renderChat();
        
        // Hide the next button initially. Game will end after 1 question.
        nextButton.classList.add('hidden');
        nextButton.textContent = "Ho√†n th√†nh tr√≤ ch∆°i";
        nextButton.onclick = showEndScreen;

        const askButton = document.getElementById('ask-gemini-button');
        const micButton = document.getElementById('mic-button');
        const promptInput = document.getElementById('gemini-prompt');
        const micStatus = document.getElementById('mic-status');

        // Re-enable inputs in case they were disabled
        promptInput.disabled = false;
        askButton.disabled = false;
        micButton.disabled = false;

        askButton.onclick = askGemini;
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                askGemini();
            }
        });

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.continuous = false;
            recognition.interimResults = false;

            micButton.onclick = () => {
                if (!questionAsked) recognition.start();
            };

            recognition.onstart = () => {
                micStatus.textContent = "üéôÔ∏è ƒêang nghe...";
                micButton.classList.add('bg-red-500');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                promptInput.value = transcript;
                setTimeout(askGemini, 200); // Automatically send after recognition
            };

            recognition.onerror = (event) => {
                micStatus.textContent = "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c gi·ªçng n√≥i, th·ª≠ l·∫°i nh√©.";
                console.error("Speech recognition error", event.error);
            };

            recognition.onend = () => {
                micStatus.textContent = "";
                micButton.classList.remove('bg-red-500');
            };
        } else {
            micButton.style.display = 'none';
            micStatus.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i.";
        }
    }
    // --- End of Updated Mission 5 ---
    
    function showEndScreen() { /* ... unchanged ... */ }
    
    // --- MODIFIED resetGame function ---
    function resetGame() {
        currentMission = 0;
        score = 0;
        mission2Round = 1;
        mission4MatchedPairs = 0;
        isSkippingMission3 = false; // ADDED
        updateScore(0);
        endScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        skipButton.classList.add('hidden'); // ADDED
    };

    startButton.addEventListener('click', () => {
        if (audioContext.state === 'suspended') { audioContext.resume(); }
        synth.getVoices();
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        gameScreen.classList.add('flex');
        speak("Xin ch√†o Phi H√†nh Gia Nh√≠! Ch√†o m·ª´ng con. Con ƒë√£ s·∫µn s√†ng ch∆∞a?", {lang: 'vi-VN'}); // Default rate 0.9
        setTimeout(setupMission1, 4000); 
    });
    
    restartButton.addEventListener('click', resetGame);

    // --- Re-pasting unchanged functions (playSound, planets) ---
    playSound = (type) => { if (!audioContext || audioContext.state === 'suspended') { audioContext.resume(); } const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioContext.currentTime); } else if (type === 'wrong') { o.type = 'square'; o.frequency.setValueAtTime(150, audioContext.currentTime); } g.gain.setValueAtTime(0.3, audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5); o.start(); o.stop(audioContext.currentTime + 0.5); };
    planets.splice(0, planets.length, { id: 'mercury', name: 'Mercury', color: '#a3a3a3', size: 'w-6 h-6 md:w-8 md:h-8' }, { id: 'venus', name: 'Venus', color: '#f59e0b', size: 'w-8 h-8 md:w-12 md:h-12' }, { id: 'earth', name: 'Earth', color: '#3b82f6', size: 'w-8 h-8 md:w-12 md:h-12' }, { id: 'mars', name: 'Mars', color: '#ef4444', size: 'w-7 h-7 md:w-10 md:h-10' }, { id: 'jupiter', name: 'Jupiter', color: '#d97706', size: 'w-12 h-12 md:w-20 md:h-20' }, { id: 'saturn', name: 'Saturn', color: '#ca8a04', size: 'w-11 h-11 md:w-16 md:h-16', hasRing: true }, { id: 'uranus', name: 'Uranus', color: '#67e8f9', size: 'w-10 h-10 md:w-14 md:h-14' }, { id: 'neptune', name: 'Neptune', color: '#60a5fa', size: 'w-10 h-10 md:w-14 md:h-14' });
    
    // --- MODIFIED funFacts array ---
    funFacts.splice(0, funFacts.length,
        {
            id: 'mercury', title: 'Sao Th·ªßy (Mercury)',
            text: "H√£y t√¨m <strong>Sao Th·ªßy (Mercury)</strong>! ƒê√¢y l√† h√†nh tinh ·ªü g·∫ßn <strong>M·∫∑t Tr·ªùi (Sun)</strong> nh·∫•t ƒë·∫•y.",
            speechText: "Sao Th·ªßy, ti·∫øng Anh l√† Mercury. H√£y t√¨m Sao Th·ªßy! ƒê√¢y l√† h√†nh tinh ·ªü g·∫ßn M·∫∑t Tr·ªùi, ti·∫øng Anh l√† Sun, nh·∫•t ƒë·∫•y."
        },
        {
            id: 'venus', title: 'Sao Kim (Venus)',
            text: "ƒê√¢y l√† <strong>Sao Kim (Venus)</strong>! ƒê√¢y l√† h√†nh tinh <strong>n√≥ng (hot)</strong> nh·∫•t trong h·ªá m·∫∑t tr·ªùi c·ªßa ch√∫ng ta.",
            speechText: "Sao Kim, ti·∫øng Anh l√† Venus. ƒê√¢y l√† Sao Kim! ƒê√¢y l√† h√†nh tinh n√≥ng, ti·∫øng Anh l√† hot, nh·∫•t trong h·ªá m·∫∑t tr·ªùi c·ªßa ch√∫ng ta."
        },
        {
            id: 'earth', title: 'Tr√°i ƒê·∫•t (Earth)',
            text: "Nh√† c·ªßa ch√∫ng ta! <strong>Tr√°i ƒê·∫•t (Earth)</strong> l√† m·ªôt h√†nh tinh <strong>ƒë√°</strong> ƒë·∫∑c bi·ªát c√≥ n∆∞·ªõc v√† s·ª± s·ªëng.",
            speechText: "Tr√°i ƒê·∫•t, ti·∫øng Anh l√† Earth. Nh√† c·ªßa ch√∫ng ta! Tr√°i ƒê·∫•t l√† m·ªôt h√†nh tinh ƒë√° ƒë·∫∑c bi·ªát c√≥ n∆∞·ªõc v√† s·ª± s·ªëng."
        },
        {
            id: 'mars', title: 'Sao H·ªèa (Mars)',
            text: "Con c√≥ th·∫•y h√†nh tinh <strong>ƒë·ªè (red)</strong> kh√¥ng? ƒê√≥ ch√≠nh l√† <strong>Sao H·ªèa (Mars)</strong>!",
            speechText: "Sao H·ªèa, ti·∫øng Anh l√† Mars. Con c√≥ th·∫•y h√†nh tinh ƒë·ªè, ti·∫øng Anh l√† red, kh√¥ng? ƒê√≥ ch√≠nh l√† Sao H·ªèa!"
        },
        {
            id: 'jupiter', title: 'Sao M·ªôc (Jupiter)',
            text: "ƒê√¢y l√† <strong>Sao M·ªôc (Jupiter)</strong>! ƒê√≥ l√† m·ªôt <strong>ng∆∞·ªùi kh·ªïng l·ªì kh√≠ (gas giant)</strong>. N√≥ r·∫•t, r·∫•t <strong>l·ªõn (big)</strong>!",
            speechText: "Sao M·ªôc, ti·∫øng Anh l√† Jupiter. ƒê√¢y l√† Sao M·ªôc! ƒê√≥ l√† m·ªôt ng∆∞·ªùi kh·ªïng l·ªì kh√≠, ti·∫øng Anh l√† gas giant. N√≥ r·∫•t, r·∫•t l·ªõn, ti·∫øng Anh l√† big!"
        },
        {
            id: 'saturn', title: 'Sao Th·ªï (Saturn)',
            text: "Wow, h√£y nh√¨n <strong>v√†nh ƒëai (ring)</strong> xinh ƒë·∫πp k√¨a! ƒê√¢y l√† <strong>Sao Th·ªï (Saturn)</strong>.",
            speechText: "Sao Th·ªï, ti·∫øng Anh l√† Saturn. Wow, h√£y nh√¨n v√†nh ƒëai, ti·∫øng Anh l√† ring, xinh ƒë·∫πp k√¨a! ƒê√¢y l√† Sao Th·ªï."
        },
        {
            id: 'uranus', title: 'Sao Thi√™n V∆∞∆°ng (Uranus)',
            text: "<strong>Sao Thi√™n V∆∞∆°ng (Uranus)</strong> l√† m·ªôt g√£ kh·ªïng l·ªì bƒÉng <strong>l·∫°nh (cold)</strong> gi√°, quay nghi√™ng m·ªôt b√™n.",
            speechText: "Sao Thi√™n V∆∞∆°ng, ti·∫øng Anh l√† Uranus. ƒê√¢y l√† m·ªôt g√£ kh·ªïng l·ªì bƒÉng l·∫°nh, ti·∫øng Anh l√† cold, gi√°, quay nghi√™ng m·ªôt b√™n."
        },
        {
            id: 'neptune', title: 'Sao H·∫£i V∆∞∆°ng (Neptune)',
            text: "<strong>Sao H·∫£i V∆∞∆°ng (Neptune)</strong> ·ªü r·∫•t, r·∫•t <strong>xa (far)</strong> v√† c√≥ m√†u <strong>xanh (blue)</strong> bi·∫øc!",
            speechText: "Sao H·∫£i V∆∞∆°ng, ti·∫øng Anh l√† Neptune. Sao H·∫£i V∆∞∆°ng ·ªü r·∫•t, r·∫•t xa, ti·∫øng Anh l√† far, v√† c√≥ m√†u xanh, ti·∫øng Anh l√† blue, bi·∫øc!"
        }
    );
    
    // --- quizItems (Unchanged) ---
    quizItems.splice(0, quizItems.length, { id: 'rocket', name: 'Rocket', viName: 'T√™n l·ª≠a (Rocket)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path fill="currentColor" d="M13.15 16.27L9.9 13.02l-3.17 3.17L2.81 12.27l3.17-3.17-3.17-3.17L6.73 2.81l3.17 3.17L13.07 2.8l1.41 3.92-3.48 3.48 3.15 3.15-1.08 3.92M15 2v4h4v2h-4v4h-2v-4H9V6h4V2h2m2 16.78V15.9l-1-1-1.05 1.05.51 1.54-1.28.42-.42-1.29L12.22 15l-1.54-.51.42-1.28 1.29.42-.42-1.29-1.53-.5L10 12.22l.51 1.54-1.28.42-.42-1.29-1.54-.51L6 12.64l.51 1.53-.51 1.54-1.29-.42.42 1.29L4.7 17.5l-1.53.5.42 1.28 1.54-.51.51-1.54 1.54.51.51 1.54.42 1.28 1.28-.42.42-1.29 1.05-1.05 1.04 1.04v.88h1.22l2.33-2.33h.03l.03-.03.02-.02.48-.48.52-.52.5-.5.44-.44c.3-.3.3-.77 0-1.06l-1-1a.75.75 0 00-1.06 0l-.44.44-.5.5-.52.52-.48.48-.02.02-.03.03h-.03z"/></svg>`}, { id: 'star', name: 'Star', viName: 'Ng√¥i sao (Star)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path fill="currentColor" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" /></svg>`}, { id: 'helmet', name: 'Helmet', viName: 'M≈© phi h√†nh gia (Helmet)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12v4c0 2.21 1.79 4 4 4h12c2.21 0 4-1.79 4-4v-4C22 6.477 17.523 2 12 2zM4 13.044V12c0-4.418 3.582-8 8-8s8 3.582 8 8v1.044A5.968 5.968 0 0118 16c0 .774-.15 1.511-.422 2.188A3.984 3.984 0 0118 18H6c-.53 0-1.036-.104-1.5-.29V16c0-1.42.58-2.705 1.5-3.655A5.968 5.968 0 014 13.044zM7 14h10v2H7v-2z" fill="currentColor"/></svg>`}, { id: 'planet', name: 'Planet', viName: 'H√†nh tinh (Planet)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.82,15.24C17.38,14.07 17.6,12.8 17.39,11.54C17.1,8.37 14.83,5.82 11.9,5.26C11.5,5.18 11.07,5.14 10.65,5.14C9.5,5.14 8.5,5.39 7.57,5.83C7,6.07 6.4,6.47 6,6.84L7.4,8.24C7.6,8.04 7.8,7.9 8.1,7.74C8.75,7.44 9.5,7.24 10.3,7.24C12.94,7.24 15.1,9.4 15.1,12C15.1,12.84 14.88,13.62 14.5,14.28L15.9,15.68C16.27,15.53 16.57,15.41 16.82,15.24M6.76,16.82C5.93,15.5 5.6,14 5.61,12.46C5.9,9.29 8.17,6.74 11.1,6.18C12.12,5.97 13.15,6 14.16,6.32L12.76,7.72C12.11,7.5 11.45,7.36 10.8,7.36C8.16,7.36 6,9.5 6,12.1C6,12.94 6.22,13.72 6.5,14.38L5.1,15.78C4.73,15.63 4.43,15.51 4.18,15.36L6.76,16.82Z" fill="currentColor" /></svg>`} );
    
    // --- playLaunchAnimation (Unchanged) ---
    playLaunchAnimation = () => { nextButton.classList.add('hidden'); const a = document.getElementById('assembly-area'), f = document.getElementById('launch-flames'); speak("ƒê·∫øm ng∆∞·ª£c... 3, 2, 1, Ph√≥ng!", {lang: 'vi-VN'}); setTimeout(() => { a.classList.add('shake'); f.style.opacity = '1'; f.classList.add('active'); }, 2000); setTimeout(() => { a.classList.remove('shake'); a.style.transition = 'transform 2s ease-in, opacity 2s'; a.style.transform = 'translateY(-150%)'; a.style.opacity = '0'; }, 4000); setTimeout(() => { a.style.transition = ''; a.style.transform = ''; a.style.opacity = '1'; f.style.opacity = '0'; f.classList.remove('active'); setupMission2(); }, 6500); };
    
    // --- setupMission1 (Unchanged) ---
    setupMission1 = () => { currentMission = 1; missionTitle.innerHTML = 'Nhi·ªám V·ª• 1: L·∫Øp R√°p T√†u Con Thoi'; updateProgressBar(); showMission(1); speak('Nhi·ªám V·ª• 1: L·∫Øp R√°p T√†u Con Thoi! K√©o c√°c b·ªô ph·∫≠n v√†o ƒë√∫ng v·ªã tr√≠ ƒë·ªÉ ho√†n th√†nh con t√†u.', {lang: 'vi-VN'}); const m1Vocab = { cone: 'Ch√≥p t√†u (cone)', body: 'Th√¢n t√†u (body)', fins: 'C√°nh (fins)' }; const d = document.querySelectorAll('#mission-1-content .draggable'), z = document.querySelectorAll('#mission-1-content .drop-zone'); d.forEach(d => { d.style.visibility = 'visible'; d.draggable = true; }); document.querySelectorAll('[id$="-assembled"]').forEach(a => a.style.opacity = '0'); z.forEach(d => d.classList.remove('correct')); let i = null, c = 0; const t = 3; d.forEach(d => { d.addEventListener('dragstart', (e) => { i = e.target.closest('.draggable'); setTimeout(() => { if (i) i.classList.add('dragging'); }, 0); }); d.addEventListener('dragend', () => { if (i) i.classList.remove('dragging'); i = null; }); }); z.forEach(z => { z.addEventListener('dragover', (e) => { e.preventDefault(); z.classList.add('drag-over'); }); z.addEventListener('dragleave', () => z.classList.remove('drag-over')); z.addEventListener('drop', (e) => { e.preventDefault(); z.classList.remove('drag-over'); if (i && i.dataset.item === z.dataset.item) { playSound('correct'); speak(m1Vocab[i.dataset.item] || i.dataset.item, { lang: 'vi-VN' }); const a = document.getElementById(`${i.dataset.item}-assembled`); if (a) a.style.opacity = '1'; i.style.visibility = 'hidden'; i.draggable = false; z.classList.add('correct'); updateScore(10); c++; if (c === t) { nextButton.textContent = "Ph√≥ng t√†u!"; nextButton.classList.remove('hidden'); nextButton.onclick = playLaunchAnimation; } } else { playSound('wrong'); if (i) { i.classList.add('shake'); setTimeout(() => i.classList.remove('shake'), 500); } } }); }); };
    
    // --- setupMission2 (Unchanged) ---
    setupMission2 = () => { currentMission = 2; missionTitle.innerHTML = 'Nhi·ªám V·ª• 2: S·∫Øp X·∫øp H·ªá M·∫∑t Tr·ªùi'; updateProgressBar(); showMission(2); const m2Vocab = { mercury: 'Sao Th·ªßy (Mercury)', venus: 'Sao Kim (Venus)', earth: 'Tr√°i ƒê·∫•t (Earth)', mars: 'Sao H·ªèa (Mars)', jupiter: 'Sao M·ªôc (Jupiter)', saturn: 'Sao Th·ªï (Saturn)', uranus: 'Sao Thi√™n V∆∞∆°ng (Uranus)', neptune: 'Sao H·∫£i V∆∞∆°ng (Neptune)' }; const psc = document.getElementById('planet-slots'), pbc = document.getElementById('planet-bank'); psc.innerHTML = ''; pbc.innerHTML = ''; document.getElementById('mission-2-subtitle').textContent = `V√≤ng ${mission2Round}: H√£y s·∫Øp x·∫øp c√°c h√†nh tinh.`; const mission2Text = document.getElementById('mission-2-subtitle').textContent; speak(`Nhi·ªám V·ª• 2: S·∫Øp X·∫øp H·ªá M·∫∑t Tr·ªùi. ${mission2Text}`, {lang: 'vi-VN'}); planets.forEach((p, i) => { const s = document.createElement('div'); s.className = 'flex-shrink-0 flex flex-col items-center justify-center'; s.innerHTML = `<div id="slot-${p.id}" data-planet="${p.id}" class="drop-zone ${p.size} rounded-full flex items-center justify-center bg-black/20">${mission2Round === 1 ? `<span class="text-white text-xl font-bold">${i + 1}</span>` : ''}</div>${mission2Round === 1 ? `<p class="text-xs mt-1 text-gray-400">${p.name}</p>` : ''}`; psc.appendChild(s); }); const sp = [...planets].sort(() => Math.random() - 0.5); sp.forEach(p => { const pe = document.createElement('div'); pe.id = `drag-${p.id}`; pe.dataset.item = p.id; pe.draggable = true; pe.className = `draggable ${p.size} rounded-full flex-shrink-0 relative planet-glow-${p.id}`; pe.style.backgroundColor = p.color; if (p.hasRing) { pe.innerHTML = `<div class="absolute w-[150%] h-[150%] border-2 border-yellow-200/50 rounded-full" style="transform: translate(-50%, -50%) rotate(30deg) skew(40deg); top: 50%; left: 50%;"></div>`; } pbc.appendChild(pe); }); let di = null, cp = 0; const dr = document.querySelectorAll('#mission-2-content .draggable'), dz = document.querySelectorAll('#mission-2-content .drop-zone'); dr.forEach(d => { d.addEventListener('dragstart', (e) => { di = e.target; setTimeout(() => e.target.style.opacity = '0.5', 0); }); d.addEventListener('dragend', (e) => { setTimeout(() => e.target.style.opacity = '1', 0); }); }); dz.forEach(z => { z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); }); z.addEventListener('dragleave', () => z.classList.remove('drag-over')); z.addEventListener('drop', (e) => { e.preventDefault(); z.classList.remove('drag-over'); if (di && di.dataset.item === z.dataset.planet) { playSound('correct'); speak(m2Vocab[z.dataset.planet] || z.dataset.planet, { lang: 'vi-VN' }); z.innerHTML = ''; z.appendChild(di); di.draggable = false; di.classList.remove('draggable'); z.classList.add('correct'); updateScore(5); cp++; if (cp === planets.length) { if (mission2Round === 1) { mission2Round = 2; nextButton.textContent = "V√≤ng 2"; nextButton.classList.remove('hidden'); nextButton.onclick = setupMission2; } else { nextButton.textContent = "Ti·∫øp theo"; nextButton.classList.remove('hidden'); nextButton.onclick = setupMission3; } } } else { playSound('wrong'); if (di) { di.classList.add('shake'); setTimeout(() => di.classList.remove('shake'), 500); } } }); }); };
    
    // --- MODIFIED setupMission3 ---
    setupMission3 = async () => {
        currentMission = 3;
        missionTitle.innerHTML = 'Nhi·ªám V·ª• 3: Kh√°m Ph√° ƒêi·ªÅu K·ª≥ Th√∫';
        updateProgressBar();
        showMission(3); // Hides skipButton
        speak('Nhi·ªám V·ª• 3: Kh√°m Ph√° ƒêi·ªÅu K·ª≥ Th√∫', {lang: 'vi-VN', rate: 0.75});
        
        isSkippingMission3 = false; // Reset flag
        skipButton.classList.remove('hidden'); // Show skip button
        skipButton.onclick = () => {
            isSkippingMission3 = true;
            synth.cancel(); // Stop speech
            document.getElementById('fun-fact-card').classList.remove('scale-100', 'opacity-100'); // Hide card
            document.getElementById('fun-fact-card').classList.add('scale-0', 'opacity-0');
            skipButton.classList.add('hidden'); // Hide self
            setupMission4(); // Go to next mission
        };

        const c = document.getElementById('fun-fact-card'), t = document.getElementById('fun-fact-title'), i = document.getElementById('fun-fact-image'), x = document.getElementById('fun-fact-text');
        
        for (const f of funFacts) {
            if (isSkippingMission3) break; // Check flag at start of loop
            await new Promise(r => setTimeout(r, 500));
            if (isSkippingMission3) break; // Check flag after await
            
            c.classList.remove('scale-0', 'opacity-0');
            c.classList.add('scale-100', 'opacity-100');
            const p = planets.find(p => p.id === f.id);
            t.textContent = f.title;
            x.innerHTML = f.text;
            let h = `<div class="${p.size} rounded-full planet-glow-${p.id}" style="background-color:${p.color}; margin: auto; position: relative;">`;
            if (p.hasRing) { h += `<div class="absolute w-[150%] h-[150%] border-2 border-yellow-200/50 rounded-full" style="transform: translate(-50%, -50%) rotate(30deg) skew(40deg); top: 50%; left: 50%;"></div>`; }
            h += '</div>';
            i.innerHTML = h;
            
            speak(f.speechText, {lang: 'vi-VN', rate: 0.75}); 
            updateScore(2); // Award points as facts are seen
            
            await new Promise(r => setTimeout(r, 9000));
            if (isSkippingMission3) break; // Check flag after await
            
            c.classList.remove('scale-100', 'opacity-100');
            c.classList.add('scale-0', 'opacity-0');
        }
        
        skipButton.classList.add('hidden'); // Hide button when loop finishes
        if (!isSkippingMission3) { // Only call if not skipped
            setupMission4();
        }
    };
    
    // --- MODIFIED setupMission4 ---
    setupMission4 = () => {
        currentMission = 4;
        missionTitle.innerHTML = 'Nhi·ªám V·ª• 4: Tr·∫Øc Nghi·ªám T·ª´ V·ª±ng';
        updateProgressBar();
        showMission(4); // Hides skipButton
        speak('Nhi·ªám V·ª• 4: Tr·∫Øc Nghi·ªám T·ª´ V·ª±ng. N·ªëi h√¨nh ·∫£nh v·ªõi t·ª´ ti·∫øng Anh ƒë√∫ng nh√©!', {lang: 'vi-VN'});
        
        skipButton.classList.remove('hidden'); // Show skip button
        skipButton.onclick = () => {
            synth.cancel();
            skipButton.classList.add('hidden');
            setupMission5(); // Go to next mission
        };

        mission4MatchedPairs = 0;
        const ic = document.getElementById('quiz-images'), wc = document.getElementById('quiz-words');
        ic.innerHTML = '';
        wc.innerHTML = '';
        const si = [...quizItems].sort(() => Math.random() - 0.5), sw = [...quizItems].sort(() => Math.random() - 0.5);
        
        si.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer'; d.dataset.id = i.id; d.innerHTML = i.svg; ic.appendChild(d); });
        sw.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer text-center'; d.dataset.id = i.id; d.innerHTML = `<span class="font-bold text-lg">${i.name}</span>`; wc.appendChild(d); });
        
        let selI = null, selW = null;
        
        ic.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selI) selI.classList.remove('selected'); selI = t; selI.classList.add('selected'); checkMatch(); });
        wc.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selW) selW.classList.remove('selected'); selW = t; selW.classList.add('selected'); checkMatch(); });
        
        function checkMatch() {
            if (!selI || !selW) return;
            if (selI.dataset.id === selW.dataset.id) {
                playSound('correct');
                const matchedItem = quizItems.find(item => item.id === selI.dataset.id);
                speak(matchedItem?.viName || selW.textContent, { lang: 'vi-VN' });
                selI.classList.add('matched');
                selW.classList.add('matched');
                selI.classList.remove('selected');
                selW.classList.remove('selected');
                updateScore(10);
                mission4MatchedPairs++;
                if (mission4MatchedPairs === quizItems.length) {
                    skipButton.classList.add('hidden'); // ADDED: Hide skip on complete
                    nextButton.textContent = "Nhi·ªám v·ª• cu·ªëi!";
                    nextButton.classList.remove('hidden');
                    nextButton.onclick = setupMission5;
                }
            } else {
                playSound('wrong');
                selI.classList.add('shake');
                selW.classList.add('shake');
                setTimeout(() => { if (selI) selI.classList.remove('shake', 'selected'); if (selW) selW.classList.remove('shake', 'selected'); selI = null; selW = null; }, 500);
            }
            if (selI && selW) {
                setTimeout(() => { if (selI && !selI.classList.contains('matched')) selI.classList.remove('selected'); if (selW && !selW.classList.contains('matched')) selW.classList.remove('selected'); selI = null; selW = null; }, 200);
            }
        }
    };
    
    // --- showEndScreen (Unchanged) ---
    showEndScreen = () => { gameScreen.classList.add('hidden'); endScreen.classList.remove('hidden'); finalScoreDisplay.textContent = score; speak("Ch√∫c m·ª´ng Phi H√†nh Gia Nh√≠! Con ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc nhi·ªám v·ª•!", {lang: 'vi-VN'}); };
});
</script>

</body>
</html>
