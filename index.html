</div>

<div id="mission-content" class="flex-grow w-full relative">
                
                <button id="skip-button" class="hidden absolute top-2 right-4 bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-full z-20">Bỏ qua</button>
                
<div id="mission-1-content" class="w-full h-full flex flex-col items-center justify-center p-4">
<h3 class="text-2xl font-bold text-center text-yellow-300 mb-1 z-10">Nhiệm Vụ 1: Lắp Ráp Tàu Con Thoi!</h3>
<p class="text-purple-200 mb-4">Kéo các bộ phận vào đúng vị trí để hoàn thành con tàu.</p>
@@ -219,6 +222,7 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
let mission2Round = 1;
let mission4MatchedPairs = 0;
let geminiChatHistory = [];
    let isSkippingMission3 = false; // ADDED

// Elements
const startScreen = document.getElementById('start-screen');
@@ -227,6 +231,7 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
const startButton = document.getElementById('start-button');
const nextButton = document.getElementById('next-button');
const restartButton = document.getElementById('restart-button');
    const skipButton = document.getElementById('skip-button'); // ADDED
const scoreDisplay = document.getElementById('score');
const finalScoreDisplay = document.getElementById('final-score');
const missionTitle = document.getElementById('mission-title');
@@ -241,10 +246,8 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
function playSound(type) { /* ... unchanged ... */ }

// --- MODIFIED speak function ---
    // Added rate and pitch to options, defaulting to 0.9 and 1.1
    // Default language is now vi-VN
speak = (text, options = {}) => {
        const { lang = 'vi-VN', rate = 0.65, pitch = 1.1 } = options;
        const { lang = 'vi-VN', rate = 0.75, pitch = 1.1 } = options;
if (!synth) return;
const u = new SpeechSynthesisUtterance(text);
const v = synth.getVoices().find(v => v.lang === lang) || synth.getVoices().find(v => v.lang.startsWith(lang.substring(0,2))) || synth.getVoices().find(v => v.lang.startsWith('en')) || synth.getVoices()[0];
@@ -266,12 +269,22 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu

function updateScore(points) { score += points; scoreDisplay.textContent = score; }
function updateProgressBar() { const progress = Math.min(100, (currentMission - 1) / 5 * 100); progressBarFill.style.width = `${progress}%`; rocketProgress.style.left = `calc(${progress}% - 12px)`; }
    function showMission(missionNumber) { Object.values(missionContents).forEach(content => content.classList.add('hidden')); if (missionContents[missionNumber]) { missionContents[missionNumber].classList.remove('hidden'); } nextButton.classList.add('hidden'); }
    
    // --- MODIFIED showMission function ---
    function showMission(missionNumber) {
        Object.values(missionContents).forEach(content => content.classList.add('hidden'));
        if (missionContents[missionNumber]) {
            missionContents[missionNumber].classList.remove('hidden');
        }
        nextButton.classList.add('hidden');
        skipButton.classList.add('hidden'); // ADDED
    }
    
function playLaunchAnimation() { /* ... unchanged ... */ }
function setupMission1() { /* ... unchanged ... */ }
function setupMission2() { /* ... unchanged ... */ }
    async function setupMission3() { /* ... unchanged ... */ }
    function setupMission4() { /* ... unchanged ... */ }
    // --- setupMission3 is MODIFIED below ---
    // --- setupMission4 is MODIFIED below ---

// --- Start of Updated Mission 5 ---
function renderChat() {
@@ -369,7 +382,7 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
currentMission = 5;
missionTitle.innerHTML = 'Nhiệm Vụ 5: ✨ Trò Chuyện Cùng Vũ Trụ ✨';
updateProgressBar();
        showMission(5);
        showMission(5); // This correctly hides skipButton
speak('Nhiệm Vụ 5: Trò Chuyện Cùng Vũ Trụ. Hỏi bất cứ điều gì con thắc mắc về không gian nhé!', {lang: 'vi-VN'}); // Default rate 0.9

questionAsked = false; // Reset flag for this mission
@@ -439,7 +452,19 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
// --- End of Updated Mission 5 ---

function showEndScreen() { /* ... unchanged ... */ }
    function resetGame() { /* ... unchanged ... */ }
    
    // --- MODIFIED resetGame function ---
    function resetGame() {
        currentMission = 0;
        score = 0;
        mission2Round = 1;
        mission4MatchedPairs = 0;
        isSkippingMission3 = false; // ADDED
        updateScore(0);
        endScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        skipButton.classList.add('hidden'); // ADDED
    };

startButton.addEventListener('click', () => {
if (audioContext.state === 'suspended') { audioContext.resume(); }
@@ -453,32 +478,92 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu

restartButton.addEventListener('click', resetGame);

    // --- Re-pasting unchanged functions (playSound, planets, funFacts, quizItems, playLaunchAnimation) ---
    // --- Re-pasting unchanged functions (playSound, planets) ---
playSound = (type) => { if (!audioContext || audioContext.state === 'suspended') { audioContext.resume(); } const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioContext.currentTime); } else if (type === 'wrong') { o.type = 'square'; o.frequency.setValueAtTime(150, audioContext.currentTime); } g.gain.setValueAtTime(0.3, audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5); o.start(); o.stop(audioContext.currentTime + 0.5); };
planets.splice(0, planets.length, { id: 'mercury', name: 'Mercury', color: '#a3a3a3', size: 'w-6 h-6 md:w-8 md:h-8' }, { id: 'venus', name: 'Venus', color: '#f59e0b', size: 'w-8 h-8 md:w-12 md:h-12' }, { id: 'earth', name: 'Earth', color: '#3b82f6', size: 'w-8 h-8 md:w-12 md:h-12' }, { id: 'mars', name: 'Mars', color: '#ef4444', size: 'w-7 h-7 md:w-10 md:h-10' }, { id: 'jupiter', name: 'Jupiter', color: '#d97706', size: 'w-12 h-12 md:w-20 md:h-20' }, { id: 'saturn', name: 'Saturn', color: '#ca8a04', size: 'w-11 h-11 md:w-16 md:h-16', hasRing: true }, { id: 'uranus', name: 'Uranus', color: '#67e8f9', size: 'w-10 h-10 md:w-14 md:h-14' }, { id: 'neptune', name: 'Neptune', color: '#60a5fa', size: 'w-10 h-10 md:w-14 md:h-14' });
    funFacts.splice(0, funFacts.length, { id: 'mercury', title: 'Sao Thủy (Mercury)', text: "Hãy tìm <strong>Sao Thủy (Mercury)</strong>! Đây là hành tinh ở gần <strong>Mặt Trời (Sun)</strong> nhất đấy." }, { id: 'venus', title: 'Sao Kim (Venus)', text: "Đây là <strong>Sao Kim (Venus)</strong>! Đây là hành tinh <strong>nóng (hot)</strong> nhất trong hệ mặt trời của chúng ta." }, { id: 'earth', title: 'Trái Đất (Earth)', text: "Nhà của chúng ta! <strong>Trái Đất (Earth)</strong> là một hành tinh <strong>đá</strong> đặc biệt có nước và sự sống." }, { id: 'mars', title: 'Sao Hỏa (Mars)', text: "Con có thấy hành tinh <strong>đỏ (red)</strong> không? Đó chính là <strong>Sao Hỏa (Mars)</strong>!" }, { id: 'jupiter', title: 'Sao Mộc (Jupiter)', text: "Đây là <strong>Sao Mộc (Jupiter)</strong>! Đó là một <strong>người khổng lồ khí (gas giant)</strong>. Nó rất, rất <strong>lớn (big)</strong>!" }, { id: 'saturn', title: 'Sao Thổ (Saturn)', text: "Wow, hãy nhìn <strong>vành đai (ring)</strong> xinh đẹp kìa! Đây là <strong>Sao Thổ (Saturn)</strong>." }, { id: 'uranus', title: 'Sao Thiên Vương (Uranus)', text: "<strong>Sao Thiên Vương (Uranus)</strong> là một gã khổng lồ băng <strong>lạnh (cold)</strong> giá, quay nghiêng một bên." }, { id: 'neptune', title: 'Sao Hải Vương (Neptune)', text: "<strong>Sao Hải Vương (Neptune)</strong> ở rất, rất <strong>xa (far)</strong> và có màu <strong>xanh (blue)</strong> biếc!" } );
    
    // --- MODIFIED funFacts array ---
    funFacts.splice(0, funFacts.length,
        {
            id: 'mercury', title: 'Sao Thủy (Mercury)',
            text: "Hãy tìm <strong>Sao Thủy (Mercury)</strong>! Đây là hành tinh ở gần <strong>Mặt Trời (Sun)</strong> nhất đấy.",
            speechText: "Sao Thủy, tiếng Anh là Mercury. Hãy tìm Sao Thủy! Đây là hành tinh ở gần Mặt Trời, tiếng Anh là Sun, nhất đấy."
        },
        {
            id: 'venus', title: 'Sao Kim (Venus)',
            text: "Đây là <strong>Sao Kim (Venus)</strong>! Đây là hành tinh <strong>nóng (hot)</strong> nhất trong hệ mặt trời của chúng ta.",
            speechText: "Sao Kim, tiếng Anh là Venus. Đây là Sao Kim! Đây là hành tinh nóng, tiếng Anh là hot, nhất trong hệ mặt trời của chúng ta."
        },
        {
            id: 'earth', title: 'Trái Đất (Earth)',
            text: "Nhà của chúng ta! <strong>Trái Đất (Earth)</strong> là một hành tinh <strong>đá</strong> đặc biệt có nước và sự sống.",
            speechText: "Trái Đất, tiếng Anh là Earth. Nhà của chúng ta! Trái Đất là một hành tinh đá đặc biệt có nước và sự sống."
        },
        {
            id: 'mars', title: 'Sao Hỏa (Mars)',
            text: "Con có thấy hành tinh <strong>đỏ (red)</strong> không? Đó chính là <strong>Sao Hỏa (Mars)</strong>!",
            speechText: "Sao Hỏa, tiếng Anh là Mars. Con có thấy hành tinh đỏ, tiếng Anh là red, không? Đó chính là Sao Hỏa!"
        },
        {
            id: 'jupiter', title: 'Sao Mộc (Jupiter)',
            text: "Đây là <strong>Sao Mộc (Jupiter)</strong>! Đó là một <strong>người khổng lồ khí (gas giant)</strong>. Nó rất, rất <strong>lớn (big)</strong>!",
            speechText: "Sao Mộc, tiếng Anh là Jupiter. Đây là Sao Mộc! Đó là một người khổng lồ khí, tiếng Anh là gas giant. Nó rất, rất lớn, tiếng Anh là big!"
        },
        {
            id: 'saturn', title: 'Sao Thổ (Saturn)',
            text: "Wow, hãy nhìn <strong>vành đai (ring)</strong> xinh đẹp kìa! Đây là <strong>Sao Thổ (Saturn)</strong>.",
            speechText: "Sao Thổ, tiếng Anh là Saturn. Wow, hãy nhìn vành đai, tiếng Anh là ring, xinh đẹp kìa! Đây là Sao Thổ."
        },
        {
            id: 'uranus', title: 'Sao Thiên Vương (Uranus)',
            text: "<strong>Sao Thiên Vương (Uranus)</strong> là một gã khổng lồ băng <strong>lạnh (cold)</strong> giá, quay nghiêng một bên.",
            speechText: "Sao Thiên Vương, tiếng Anh là Uranus. Đây là một gã khổng lồ băng lạnh, tiếng Anh là cold, giá, quay nghiêng một bên."
        },
        {
            id: 'neptune', title: 'Sao Hải Vương (Neptune)',
            text: "<strong>Sao Hải Vương (Neptune)</strong> ở rất, rất <strong>xa (far)</strong> và có màu <strong>xanh (blue)</strong> biếc!",
            speechText: "Sao Hải Vương, tiếng Anh là Neptune. Sao Hải Vương ở rất, rất xa, tiếng Anh là far, và có màu xanh, tiếng Anh là blue, biếc!"
        }
    );
    
    // --- quizItems (Unchanged) ---
quizItems.splice(0, quizItems.length, { id: 'rocket', name: 'Rocket', viName: 'Tên lửa (Rocket)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path fill="currentColor" d="M13.15 16.27L9.9 13.02l-3.17 3.17L2.81 12.27l3.17-3.17-3.17-3.17L6.73 2.81l3.17 3.17L13.07 2.8l1.41 3.92-3.48 3.48 3.15 3.15-1.08 3.92M15 2v4h4v2h-4v4h-2v-4H9V6h4V2h2m2 16.78V15.9l-1-1-1.05 1.05.51 1.54-1.28.42-.42-1.29L12.22 15l-1.54-.51.42-1.28 1.29.42-.42-1.29-1.53-.5L10 12.22l.51 1.54-1.28.42-.42-1.29-1.54-.51L6 12.64l.51 1.53-.51 1.54-1.29-.42.42 1.29L4.7 17.5l-1.53.5.42 1.28 1.54-.51.51-1.54 1.54.51.51 1.54.42 1.28 1.28-.42.42-1.29 1.05-1.05 1.04 1.04v.88h1.22l2.33-2.33h.03l.03-.03.02-.02.48-.48.52-.52.5-.5.44-.44c.3-.3.3-.77 0-1.06l-1-1a.75.75 0 00-1.06 0l-.44.44-.5.5-.52.52-.48.48-.02.02-.03.03h-.03z"/></svg>`}, { id: 'star', name: 'Star', viName: 'Ngôi sao (Star)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path fill="currentColor" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" /></svg>`}, { id: 'helmet', name: 'Helmet', viName: 'Mũ phi hành gia (Helmet)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12v4c0 2.21 1.79 4 4 4h12c2.21 0 4-1.79 4-4v-4C22 6.477 17.523 2 12 2zM4 13.044V12c0-4.418 3.582-8 8-8s8 3.582 8 8v1.044A5.968 5.968 0 0118 16c0 .774-.15 1.511-.422 2.188A3.984 3.984 0 0118 18H6c-.53 0-1.036-.104-1.5-.29V16c0-1.42.58-2.705 1.5-3.655A5.968 5.968 0 014 13.044zM7 14h10v2H7v-2z" fill="currentColor"/></svg>`}, { id: 'planet', name: 'Planet', viName: 'Hành tinh (Planet)', svg: `<svg class="w-12 h-12" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.82,15.24C17.38,14.07 17.6,12.8 17.39,11.54C17.1,8.37 14.83,5.82 11.9,5.26C11.5,5.18 11.07,5.14 10.65,5.14C9.5,5.14 8.5,5.39 7.57,5.83C7,6.07 6.4,6.47 6,6.84L7.4,8.24C7.6,8.04 7.8,7.9 8.1,7.74C8.75,7.44 9.5,7.24 10.3,7.24C12.94,7.24 15.1,9.4 15.1,12C15.1,12.84 14.88,13.62 14.5,14.28L15.9,15.68C16.27,15.53 16.57,15.41 16.82,15.24M6.76,16.82C5.93,15.5 5.6,14 5.61,12.46C5.9,9.29 8.17,6.74 11.1,6.18C12.12,5.97 13.15,6 14.16,6.32L12.76,7.72C12.11,7.5 11.45,7.36 10.8,7.36C8.16,7.36 6,9.5 6,12.1C6,12.94 6.22,13.72 6.5,14.38L5.1,15.78C4.73,15.63 4.43,15.51 4.18,15.36L6.76,16.82Z" fill="currentColor" /></svg>`} );
    
    // --- playLaunchAnimation (Unchanged) ---
playLaunchAnimation = () => { nextButton.classList.add('hidden'); const a = document.getElementById('assembly-area'), f = document.getElementById('launch-flames'); speak("Đếm ngược... 3, 2, 1, Phóng!", {lang: 'vi-VN'}); setTimeout(() => { a.classList.add('shake'); f.style.opacity = '1'; f.classList.add('active'); }, 2000); setTimeout(() => { a.classList.remove('shake'); a.style.transition = 'transform 2s ease-in, opacity 2s'; a.style.transform = 'translateY(-150%)'; a.style.opacity = '0'; }, 4000); setTimeout(() => { a.style.transition = ''; a.style.transform = ''; a.style.opacity = '1'; f.style.opacity = '0'; f.classList.remove('active'); setupMission2(); }, 6500); };

    // --- setupMission1 (Unchanged from previous turn) ---
    // --- setupMission1 (Unchanged) ---
setupMission1 = () => { currentMission = 1; missionTitle.innerHTML = 'Nhiệm Vụ 1: Lắp Ráp Tàu Con Thoi'; updateProgressBar(); showMission(1); speak('Nhiệm Vụ 1: Lắp Ráp Tàu Con Thoi! Kéo các bộ phận vào đúng vị trí để hoàn thành con tàu.', {lang: 'vi-VN'}); const m1Vocab = { cone: 'Chóp tàu (cone)', body: 'Thân tàu (body)', fins: 'Cánh (fins)' }; const d = document.querySelectorAll('#mission-1-content .draggable'), z = document.querySelectorAll('#mission-1-content .drop-zone'); d.forEach(d => { d.style.visibility = 'visible'; d.draggable = true; }); document.querySelectorAll('[id$="-assembled"]').forEach(a => a.style.opacity = '0'); z.forEach(d => d.classList.remove('correct')); let i = null, c = 0; const t = 3; d.forEach(d => { d.addEventListener('dragstart', (e) => { i = e.target.closest('.draggable'); setTimeout(() => { if (i) i.classList.add('dragging'); }, 0); }); d.addEventListener('dragend', () => { if (i) i.classList.remove('dragging'); i = null; }); }); z.forEach(z => { z.addEventListener('dragover', (e) => { e.preventDefault(); z.classList.add('drag-over'); }); z.addEventListener('dragleave', () => z.classList.remove('drag-over')); z.addEventListener('drop', (e) => { e.preventDefault(); z.classList.remove('drag-over'); if (i && i.dataset.item === z.dataset.item) { playSound('correct'); speak(m1Vocab[i.dataset.item] || i.dataset.item, { lang: 'vi-VN' }); const a = document.getElementById(`${i.dataset.item}-assembled`); if (a) a.style.opacity = '1'; i.style.visibility = 'hidden'; i.draggable = false; z.classList.add('correct'); updateScore(10); c++; if (c === t) { nextButton.textContent = "Phóng tàu!"; nextButton.classList.remove('hidden'); nextButton.onclick = playLaunchAnimation; } } else { playSound('wrong'); if (i) { i.classList.add('shake'); setTimeout(() => i.classList.remove('shake'), 500); } } }); }); };

    // --- setupMission2 (Unchanged from previous turn) ---
    // --- setupMission2 (Unchanged) ---
setupMission2 = () => { currentMission = 2; missionTitle.innerHTML = 'Nhiệm Vụ 2: Sắp Xếp Hệ Mặt Trời'; updateProgressBar(); showMission(2); const m2Vocab = { mercury: 'Sao Thủy (Mercury)', venus: 'Sao Kim (Venus)', earth: 'Trái Đất (Earth)', mars: 'Sao Hỏa (Mars)', jupiter: 'Sao Mộc (Jupiter)', saturn: 'Sao Thổ (Saturn)', uranus: 'Sao Thiên Vương (Uranus)', neptune: 'Sao Hải Vương (Neptune)' }; const psc = document.getElementById('planet-slots'), pbc = document.getElementById('planet-bank'); psc.innerHTML = ''; pbc.innerHTML = ''; document.getElementById('mission-2-subtitle').textContent = `Vòng ${mission2Round}: Hãy sắp xếp các hành tinh.`; const mission2Text = document.getElementById('mission-2-subtitle').textContent; speak(`Nhiệm Vụ 2: Sắp Xếp Hệ Mặt Trời. ${mission2Text}`, {lang: 'vi-VN'}); planets.forEach((p, i) => { const s = document.createElement('div'); s.className = 'flex-shrink-0 flex flex-col items-center justify-center'; s.innerHTML = `<div id="slot-${p.id}" data-planet="${p.id}" class="drop-zone ${p.size} rounded-full flex items-center justify-center bg-black/20">${mission2Round === 1 ? `<span class="text-white text-xl font-bold">${i + 1}</span>` : ''}</div>${mission2Round === 1 ? `<p class="text-xs mt-1 text-gray-400">${p.name}</p>` : ''}`; psc.appendChild(s); }); const sp = [...planets].sort(() => Math.random() - 0.5); sp.forEach(p => { const pe = document.createElement('div'); pe.id = `drag-${p.id}`; pe.dataset.item = p.id; pe.draggable = true; pe.className = `draggable ${p.size} rounded-full flex-shrink-0 relative planet-glow-${p.id}`; pe.style.backgroundColor = p.color; if (p.hasRing) { pe.innerHTML = `<div class="absolute w-[150%] h-[150%] border-2 border-yellow-200/50 rounded-full" style="transform: translate(-50%, -50%) rotate(30deg) skew(40deg); top: 50%; left: 50%;"></div>`; } pbc.appendChild(pe); }); let di = null, cp = 0; const dr = document.querySelectorAll('#mission-2-content .draggable'), dz = document.querySelectorAll('#mission-2-content .drop-zone'); dr.forEach(d => { d.addEventListener('dragstart', (e) => { di = e.target; setTimeout(() => e.target.style.opacity = '0.5', 0); }); d.addEventListener('dragend', (e) => { setTimeout(() => e.target.style.opacity = '1', 0); }); }); dz.forEach(z => { z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag-over'); }); z.addEventListener('dragleave', () => z.classList.remove('drag-over')); z.addEventListener('drop', (e) => { e.preventDefault(); z.classList.remove('drag-over'); if (di && di.dataset.item === z.dataset.planet) { playSound('correct'); speak(m2Vocab[z.dataset.planet] || z.dataset.planet, { lang: 'vi-VN' }); z.innerHTML = ''; z.appendChild(di); di.draggable = false; di.classList.remove('draggable'); z.classList.add('correct'); updateScore(5); cp++; if (cp === planets.length) { if (mission2Round === 1) { mission2Round = 2; nextButton.textContent = "Vòng 2"; nextButton.classList.remove('hidden'); nextButton.onclick = setupMission2; } else { nextButton.textContent = "Tiếp theo"; nextButton.classList.remove('hidden'); nextButton.onclick = setupMission3; } } } else { playSound('wrong'); if (di) { di.classList.add('shake'); setTimeout(() => di.classList.remove('shake'), 500); } } }); }); };

// --- MODIFIED setupMission3 ---
setupMission3 = async () => {
currentMission = 3;
missionTitle.innerHTML = 'Nhiệm Vụ 3: Khám Phá Điều Kỳ Thú';
updateProgressBar();
        showMission(3);
        // Speak title slowly
        speak('Nhiệm Vụ 3: Khám Phá Điều Kỳ Thú', {lang: 'vi-VN', rate: 0.75}); 
        nextButton.classList.add('hidden');
        showMission(3); // Hides skipButton
        speak('Nhiệm Vụ 3: Khám Phá Điều Kỳ Thú', {lang: 'vi-VN', rate: 0.75});
        
        isSkippingMission3 = false; // Reset flag
        skipButton.classList.remove('hidden'); // Show skip button
        skipButton.onclick = () => {
            isSkippingMission3 = true;
            synth.cancel(); // Stop speech
            document.getElementById('fun-fact-card').classList.remove('scale-100', 'opacity-100'); // Hide card
            document.getElementById('fun-fact-card').classList.add('scale-0', 'opacity-0');
            skipButton.classList.add('hidden'); // Hide self
            setupMission4(); // Go to next mission
        };

const c = document.getElementById('fun-fact-card'), t = document.getElementById('fun-fact-title'), i = document.getElementById('fun-fact-image'), x = document.getElementById('fun-fact-text');

for (const f of funFacts) {
            if (isSkippingMission3) break; // Check flag at start of loop
await new Promise(r => setTimeout(r, 500));
            if (isSkippingMission3) break; // Check flag after await
            
c.classList.remove('scale-0', 'opacity-0');
c.classList.add('scale-100', 'opacity-100');
const p = planets.find(p => p.id === f.id);
@@ -489,29 +574,85 @@ <h2 class="text-2xl md:text-3xl text-purple-300 mb-6">Con đã hoàn thành xu
h += '</div>';
i.innerHTML = h;

            // MODIFIED: Speak fact slowly (rate 0.75)
            speak(f.text.replace(/<[^>]*>/g, ''), {lang: 'vi-VN', rate: 0.75}); 
            updateScore(2);
            speak(f.speechText, {lang: 'vi-VN', rate: 0.75}); 
            updateScore(2); // Award points as facts are seen

            // MODIFIED: Wait time increased to 7000ms (7s) for slower speech
            await new Promise(r => setTimeout(r, 7000)); 
            await new Promise(r => setTimeout(r, 9000));
            if (isSkippingMission3) break; // Check flag after await

c.classList.remove('scale-100', 'opacity-100');
c.classList.add('scale-0', 'opacity-0');
}
        setupMission4();
        
        skipButton.classList.add('hidden'); // Hide button when loop finishes
        if (!isSkippingMission3) { // Only call if not skipped
            setupMission4();
        }
};

    // --- setupMission4 (Unchanged from previous turn) ---
    setupMission4 = () => { currentMission = 4; missionTitle.innerHTML = 'Nhiệm Vụ 4: Trắc Nghiệm Từ Vựng'; updateProgressBar(); showMission(4); speak('Nhiệm Vụ 4: Trắc Nghiệm Từ Vựng. Nối hình ảnh với từ tiếng Anh đúng nhé!', {lang: 'vi-VN'}); mission4MatchedPairs = 0; const ic = document.getElementById('quiz-images'), wc = document.getElementById('quiz-words'); ic.innerHTML = ''; wc.innerHTML = ''; const si = [...quizItems].sort(() => Math.random() - 0.5), sw = [...quizItems].sort(() => Math.random() - 0.5); si.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer'; d.dataset.id = i.id; d.innerHTML = i.svg; ic.appendChild(d); }); sw.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer text-center'; d.dataset.id = i.id; d.innerHTML = `<span class="font-bold text-lg">${i.name}</span>`; wc.appendChild(d); }); let selI = null, selW = null; ic.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selI) selI.classList.remove('selected'); selI = t; selI.classList.add('selected'); checkMatch(); }); wc.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selW) selW.classList.remove('selected'); selW = t; selW.classList.add('selected'); checkMatch(); }); function checkMatch() { if (!selI || !selW) return; if (selI.dataset.id === selW.dataset.id) { playSound('correct'); const matchedItem = quizItems.find(item => item.id === selI.dataset.id); speak(matchedItem?.viName || selW.textContent, { lang: 'vi-VN' }); selI.classList.add('matched'); selW.classList.add('matched'); selI.classList.remove('selected'); selW.classList.remove('selected'); updateScore(10); mission4MatchedPairs++; if (mission4MatchedPairs === quizItems.length) { nextButton.textContent = "Nhiệm vụ cuối!"; nextButton.classList.remove('hidden'); nextButton.onclick = setupMission5; } } else { playSound('wrong'); selI.classList.add('shake'); selW.classList.add('shake'); setTimeout(() => { if (selI) selI.classList.remove('shake', 'selected'); if (selW) selW.classList.remove('shake', 'selected'); selI = null; selW = null; }, 500); } if (selI && selW) { setTimeout(() => { if (selI && !selI.classList.contains('matched')) selI.classList.remove('selected'); if (selW && !selW.classList.contains('matched')) selW.classList.remove('selected'); selI = null; selW = null; }, 200); } } };
    // --- MODIFIED setupMission4 ---
    setupMission4 = () => {
        currentMission = 4;
        missionTitle.innerHTML = 'Nhiệm Vụ 4: Trắc Nghiệm Từ Vựng';
        updateProgressBar();
        showMission(4); // Hides skipButton
        speak('Nhiệm Vụ 4: Trắc Nghiệm Từ Vựng. Nối hình ảnh với từ tiếng Anh đúng nhé!', {lang: 'vi-VN'});
        
        skipButton.classList.remove('hidden'); // Show skip button
        skipButton.onclick = () => {
            synth.cancel();
            skipButton.classList.add('hidden');
            setupMission5(); // Go to next mission
        };

        mission4MatchedPairs = 0;
        const ic = document.getElementById('quiz-images'), wc = document.getElementById('quiz-words');
        ic.innerHTML = '';
        wc.innerHTML = '';
        const si = [...quizItems].sort(() => Math.random() - 0.5), sw = [...quizItems].sort(() => Math.random() - 0.5);
        
        si.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer'; d.dataset.id = i.id; d.innerHTML = i.svg; ic.appendChild(d); });
        sw.forEach(i => { const d = document.createElement('div'); d.className = 'quiz-item p-2 rounded-lg cursor-pointer text-center'; d.dataset.id = i.id; d.innerHTML = `<span class="font-bold text-lg">${i.name}</span>`; wc.appendChild(d); });
        
        let selI = null, selW = null;
        
        ic.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selI) selI.classList.remove('selected'); selI = t; selI.classList.add('selected'); checkMatch(); });
        wc.addEventListener('click', (e) => { const t = e.target.closest('.quiz-item'); if (!t || t.classList.contains('matched')) return; if (selW) selW.classList.remove('selected'); selW = t; selW.classList.add('selected'); checkMatch(); });
        
        function checkMatch() {
            if (!selI || !selW) return;
            if (selI.dataset.id === selW.dataset.id) {
                playSound('correct');
                const matchedItem = quizItems.find(item => item.id === selI.dataset.id);
                speak(matchedItem?.viName || selW.textContent, { lang: 'vi-VN' });
                selI.classList.add('matched');
                selW.classList.add('matched');
                selI.classList.remove('selected');
                selW.classList.remove('selected');
                updateScore(10);
                mission4MatchedPairs++;
                if (mission4MatchedPairs === quizItems.length) {
                    skipButton.classList.add('hidden'); // ADDED: Hide skip on complete
                    nextButton.textContent = "Nhiệm vụ cuối!";
                    nextButton.classList.remove('hidden');
                    nextButton.onclick = setupMission5;
                }
            } else {
                playSound('wrong');
                selI.classList.add('shake');
                selW.classList.add('shake');
                setTimeout(() => { if (selI) selI.classList.remove('shake', 'selected'); if (selW) selW.classList.remove('shake', 'selected'); selI = null; selW = null; }, 500);
            }
            if (selI && selW) {
                setTimeout(() => { if (selI && !selI.classList.contains('matched')) selI.classList.remove('selected'); if (selW && !selW.classList.contains('matched')) selW.classList.remove('selected'); selI = null; selW = null; }, 200);
            }
        }
    };

    // --- showEndScreen & resetGame (Unchanged from previous turn) ---
    // --- showEndScreen (Unchanged) ---
showEndScreen = () => { gameScreen.classList.add('hidden'); endScreen.classList.remove('hidden'); finalScoreDisplay.textContent = score; speak("Chúc mừng Phi Hành Gia Nhí! Con đã hoàn thành xuất sắc nhiệm vụ!", {lang: 'vi-VN'}); };
    resetGame = () => { currentMission = 0; score = 0; mission2Round = 1; mission4MatchedPairs = 0; updateScore(0); endScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); };
});
</script>

</body>
</html>

